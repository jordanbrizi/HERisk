<!DOCTYPE html>
<html lang="pt-br">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>HERisk</title>
	<link rel="stylesheet" type="text/css" href="css/app.css">
	<script src="./react.production.min.js" crossorigin></script>
	<script src="./react-dom.production.min.js" crossorigin></script>
	<script src="./react-transition-group.min.js" crossorigin></script>
	<script src="./babel.min.js" crossorigin></script>
</head>

<body>
	<main></main>
</body>

<script>
	const rend = require('./renderer.js')
	const $ = arg => document.querySelector(arg)
	const $$ = arg => document.querySelectorAll(arg)
	const toggleConfig = () => {
		if ($('header').style.height === '0px') {
			$('header').classList.toggle('slide')
			$('#config-footer').classList.toggle('slide')
		}
		else {
			$('header').classList.toggle('slide')
			$('#config-footer').classList.toggle('slide')
		}
	}
	const defaultLang = lang => {
		if(getActualLang) {
			rend.ipcRenderer.send('lang', getActualLang)
			if (lang === 'br') {
			$$('* [data-br]').forEach(e => {
				e.innerHTML = e.dataset.br
				e.setAttribute('title', e.dataset.br_title)
			})
			}
			if (lang === 'default') {
				$$('* [data-en]').forEach(e => {
					e.innerHTML = e.dataset.en
					e.setAttribute('title', e.dataset.en_title)
				})
			}
		}
		else {
			localStorage.setItem('lang', 'default')
			location.reload()
		}
	}
	const setLang = arg => {
		localStorage.setItem('lang', arg)// location.reload()
		defaultLang(arg)
		toggleConfig()
	}
	const getActualLang = localStorage.getItem('lang')
</script>
<script type="text/babel">
import { Container, Alert, Button, Nav, NavItem, NavLink } from "reactstrap"
// OBJETO COM AS FUNÇÕES DE CLICKS DO LINKS

const clicks = {
	abrirPlanilha: () =>
		rend.shell.openPath(rend.remote.app.getAppPath() + '\\bin\\input.xlsm'),
	showAboutPanel: () =>
		rend.remote.app.showAboutPanel(),
	gerarOds: () =>
		rend.ipcRenderer.send('gerarOds'),
	execute: () => {
		rend.ipcRenderer.send('execute') // EXECUTA O HERISK.EXE
	},
	guide: () =>
		rend.ipcRenderer.send('guide'),
	minimize: () =>
		rend.remote.BrowserWindow.getFocusedWindow().minimize(),
	sair: () =>
		rend.ipcRenderer.send('sair')
}

// COMPONENTES DO REACT

const Top = () => {
	return (
		<Container>
			<div id="title-bar"></div>
			<div className="btn-group btn-group-lg text-right" id="top-buttons">
				<button title="Minimize" className="btn btn-primary btn-main"
					id="minimize_button"
					onClick={clicks.minimize}>
				</button>
				<button title="Close" className="btn btn-danger btn-main" id="close_button"
					onClick={clicks.sair}></button>
			</div>
		</Container>
	)
}


class Header extends React.Component {
	render() {
		return (
			<header className="pb-3 fixed-top bg-primary">
				<div className="container-fluid bg-light" id="config">
					<p className="m-0 pt-2 user-select-none">
						<span data-en="Change language:" data-br="Alterar língua">Change language:</span>
					</p>
					<a href="#" onClick={() => setLang('default')}>
						<img src="images/enus.png" alt="English USA" title="English USA"/>
					</a>
					<a href="#" onClick={() => setLang('br')}>
						<img src="images/ptbr.png" alt="Português Brasil" title="Português Brasil"/>
					</a>
					<h1 className="m-0 mt-4 user-select-none" id="logo">HE<b>Risk</b></h1>
				</div>
			</header>
		)
	}
}

class Section extends React.Component {
	constructor(props) {
		super(props)
		this.state = {
			execute: getActualLang === 'br' ? 'Executar' : 'Execute',
			desativado: true,
			status: false,
			message: '',
			color: 'success'
		}
	}
	componentWillUnmount = () => {
	}
	componentDidMount = () => {
	}
	execute = () => {
		rend.ipcRenderer.send('execute', getActualLang)
		rend.ipcRenderer.on('responseError', (_, args) => {
			this.setState({
				message: args,
				status: true,
				color: 'danger',
				execute: getActualLang === 'br' ? 'Executar' : 'Execute'
			})
		})
		rend.ipcRenderer.on('responseSuccess', (_, args) => {
			this.setState({
				message: args,
				status: true,
				color: 'success',
				execute: getActualLang === 'br' ? 'Executado' : 'Executed',
				desativado: false
			})
		})
		setTimeout(() => {
			this.setState({ status: false })
		}, 15000)
	}

	// -------------------------------------------------------------------------
	// -------------------------------------------------------------------------
	
	gerarOds = () => {
		rend.ipcRenderer.send('gerarOds', getActualLang)
		rend.ipcRenderer.on('responseError', (_, args) => {
			this.setState({ message: args, status: true, color: 'danger'})
		})
		rend.ipcRenderer.on('responseSuccess', (_, args) => {
			this.setState({ success: args, status: true, color: 'success'})
		})
		setTimeout(() => {
			this.setState({ status: false })
		}, 15000)
	}
	render() {
		return (
			<section>
				<Container>
					<div id="alerts">
						<Alert
							color={this.state.color}
							id="alertas"
							className="text-center"
							isOpen={this.state.status}>
							<b>{this.state.message}</b>
						</Alert>
					</div>
					<Nav vertical id="menu-principal">
						<NavItem>
							<NavLink
								className="nav-link p-0 mb-2"
								onClick={clicks.abrirPlanilha}
								title="Open spreadsheet to input data."
								data-en_title="Open spreadsheet to input data."
								data-br_title="Abrir planilha para inserir os dados."
								data-en="Input data"
								data-br="Inserir dados">
								Input data
								</NavLink>
						</NavItem>
						<NavItem>
							<NavLink
								className="nav-link p-0 mb-2"
								onClick={this.execute}
								title="Execute the HERisk."
								data-en_title="Execute the HERisk."
								data-br_title="Executar o HERisk."
								data-en="Execute"
								data-br="Executar">
								{this.state.execute}
							</NavLink>
						</NavItem>
						<NavItem>
							<NavLink
								className="nav-link p-0 mb-2"
								title="Save worksheets of the results."
								data-en_title="Save worksheets of the results."
								data-br_title="Salvar planilhas dos resultados."
								data-en="Save results"
								data-br="Salvar resultados"
								onClick={this.gerarOds}
								disabled={this.state.desativado}>
								Save results
								</NavLink>
						</NavItem>
					</Nav>
					<hr />
					<Nav id="menu-bottom" vertical>
						<NavItem>
							<NavLink
								className="nav-link p-0 m-0"
								title="Video guide on how to use the program."
								data-en_title="Video guide on how to use the program."
								data-br_title="Guia em vídeo de como usar o programa."
								data-en="How to use"
								data-br="Como usar">
								How to use
							</NavLink>
						</NavItem>
						<NavItem>
							<NavLink
								className="nav-link p-0 m-0"
								title="See the guide in PDF."
								data-en_title="See the guide in PDF."
								data-br_title="Veja o guia em PDF."
								data-en="Guide"
								data-br="Guia"
								onClick={clicks.guide}>Guide
								</NavLink>
						</NavItem>
						<NavItem>
							<NavLink
								className="nav-link p-0 m-0"
								title="Set preferences."
								data-en_title="Set preferences."
								data-br_title="Alterar as configurações."
								onClick={() => toggleConfig()}>Preferences
								</NavLink>
						</NavItem>
						<NavItem>
							<NavLink
								className="nav-link p-0 m-0"
								title="About HERisk"
								data-en_title="About HERisk."
								data-br_title="Sobre o HERisk."
								data-en="About"
								data-br="Sobre"
								onClick={clicks.showAboutPanel}>About
								</NavLink>
						</NavItem>
					</Nav>
				</Container>
			</section>
		)
	}
}

const Footer = props => {
	return (
		<footer className="fixed-bottom">
			<Container>
				<p className="pt-3 user-select-none">
					&copy; 2020 - {new Date().getFullYear()}.
					<span
						title="All rights reserved."
						data-en_title="All rights reserved."
						data-br_title="Todos os direitos reservados."
						data-en=" All rights reserved."
						data-br=" Todos os direitos reservados."> All rights reserved.</span>
				</p>
			</Container>
			<Container id="config-footer">
				<p className="m-0 pt-3 user-select-none">
					<span
					data-en_title="Version"
					data-br_title="Versão"
					data-en="Version "
					data-br="Versão ">Version </span>
					<span className="version">
						{rend.remote.app.getVersion()}
					</span>
				</p>
			</Container>
		</footer>
	)
}

// RENDERIZAR APLICAÇÃO

ReactDOM.render(
	<div>
		<Top />
		<Header />
		<Section />
		<Footer />
	</div>,
	$('main')
)

// CHAMAR A FUNÇÃO DE TRADUÇÃO COM A LÍNGUA ATUAL

defaultLang(getActualLang)

</script>
</html>